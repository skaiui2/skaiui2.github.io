<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>sparrow系列十八 | Hexo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">sparrow系列十八</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">sparrow系列十八</h1><div class="post-meta">2024-10-28</div><div class="post-content"><p>skaiuijing</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面已经说过了，Sparrow采用的是时间触发系统的设计，本章将会讲解时钟触发相关的算法。</p>
<p>重新回顾一下时间触发系统的定义：</p>
<p><strong>时间触发系统的</strong>任务调度基于定时器中断，适用于周期性任务和确定性要求高的场景，如控制系统。它的内部有一个时钟，每隔一定时间间隔就会触发一次时间中断，每次时钟中断时，调度器决定是否需要切换任务。</p>
<h2 id="systick时钟"><a href="#systick时钟" class="headerlink" title="systick时钟"></a>systick时钟</h2><p>systick时钟是为RTOS而设计的的一个中断时钟，它使得RTOS在不同架构之间的移植性难度大大减小。</p>
<p><img src="C:\Users\el\AppData\Roaming\Typora\typora-user-images\image-20241029170450390.png" alt="image-20241029170450390"></p>
<p>在前面的文章中，笔者曾经调试过Sparrow来了解RTOS内部的中断使用，当时得出的结论是：SysTick中断会在一定时间间隔响应，然后触发PendSV中断产生上下文切换：</p>
<p><img src="C:\Users\el\AppData\Roaming\Typora\typora-user-images\image-20241029170253759.png" alt="image-20241029170253759"></p>
<p>systick中断用法如下：</p>
<p><img src="C:\Users\el\AppData\Roaming\Typora\typora-user-images\image-20241029171016883.png" alt="image-20241029171016883"></p>
<h2 id="如何使用时钟"><a href="#如何使用时钟" class="headerlink" title="如何使用时钟"></a>如何使用时钟</h2><h4 id="定时上下文切换"><a href="#定时上下文切换" class="headerlink" title="定时上下文切换"></a>定时上下文切换</h4><p>参考上面的程序，我们可以先设置SysTick时钟，让它在一定时间间隔响应，然后在SysTick中断中加入PendSV中断的触发函数，这样就能达到定时上下文切换的目的。</p>
<p>除此之外，SysTick本身就是一个定时器，RTOS中需要定时的地方太多了，我们必须高效利用它的定时功能。</p>
<h2 id="延时阻塞态"><a href="#延时阻塞态" class="headerlink" title="延时阻塞态"></a>延时阻塞态</h2><h4 id="利用延时的时间"><a href="#利用延时的时间" class="headerlink" title="利用延时的时间"></a>利用延时的时间</h4><p>在Sparrow中，任务有就绪态、阻塞态、挂起态三种状态，任何任务只能有一种状态。延时就是一种阻塞态，表示它在等待某个事情的发生。</p>
<p>让我们想一想，在非RTOS的环境中，我们的延时一般都是空等，但是在RTOS环境中，任务被分解为线程的形式，每个线程尽量与其他线程并行执行，那么，我们是不是可以在其他线程延时等待时，把它移除就绪表，然后把时间让给其他线程执行呢？等时间一到，再把它加入就绪表。</p>
<p>这当然是可行的。</p>
<h3 id="如何设计算法？"><a href="#如何设计算法？" class="headerlink" title="如何设计算法？"></a>如何设计算法？</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">Aa(时钟计时提供时间基准)</span><br><span class="line">Ab(就绪表)--延时则加入延时表--&gt;Ac(任务一)--&gt;Bc(任务二)</span><br><span class="line">Sb(延时表)--定期检查延时结束时间_时间到就加入就绪表--&gt;Sc(任务A_延时结束时间)--&gt;Sp(任务B_延时结束时间)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>如图所示，我们需要一张延时表，当每个任务延时时，这个任务会被踢出就绪表，延时表会记录它延时到期的时间，每一次SysTIck中断时，时间基数就会加1，然后我们可以先比较延时表中的任务是否到时间，如果到时间，那么就从延时表删除，加入就绪表，如果没到，就继续等。</p>
<h3 id="如何解决溢出的问题？"><a href="#如何解决溢出的问题？" class="headerlink" title="如何解决溢出的问题？"></a>如何解决溢出的问题？</h3><p>我们知道计算机中一个数的大小是有上限的，比如uint_32，最大只能到2^32 - 1。如果发生了溢出那怎么办呢？</p>
<p>笔者提供两种思路：</p>
<p>1.设置更大的计数单位   </p>
<p>2.使用两个表进行维护。</p>
<p>当然，Sparrow使用的是后一种。</p>
<h4 id="设置更大的计数单位"><a href="#设置更大的计数单位" class="headerlink" title="设置更大的计数单位"></a>设置更大的计数单位</h4><p>请读者想一想，我们每天都是24小时轮转，但我们是怎么表示时间的呢？是通过年、月、日来进行记录，也就是说，SysTick的计数也可以这样干，每溢出一次，前面的计数单位就加一，这样就能记录事情发生的先后了。</p>
<p>但是假设时间非常漫长，那么单片机会不断的设置更大的计数单位，从秒、分、时、日、月，一直到年，每一个数字都需要内存来存储，这样的方法，缺点是内存并不固定。</p>
<p>当然，这是考虑时间永久的情况下，实际生活中，1s计数1000次，约等于2^10,一分钟约等于计数2^16,一小时约等于2^22,三天约等于2^28,48天约等于2^32。</p>
<p>既然溢出一次需要48天，那么只要我们使用两个计数单位，那么上限不就是48*2^32天了？理论上就可以计数到产品损坏了。</p>
<h3 id="使用两个表进行维护"><a href="#使用两个表进行维护" class="headerlink" title="使用两个表进行维护"></a>使用两个表进行维护</h3><p>正常情况下，任务的延时加上当前时间最多溢出一次，例如1 + 2^32 -1 会溢出一次，虽然1 + 2^32 - 1 + 2^32会溢出两次 ，但是这个时间段太长了，太离谱了，根本不可能被使用。既然最多溢出一次，那么，只要多一个表就可以解决溢出的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line"></span><br><span class="line">Aa(记录没有溢出的延时表)--&gt;Ab(记录的时间)--&gt;Ac(记录的时间)</span><br><span class="line">Ba(记录溢出的延时表)--&gt;Bb(记录的时间)--&gt;Bc(记录的时间)</span><br></pre></td></tr></table></figure>



<p>当时间溢出发生时，由于此时记录没有溢出的延时表的任务肯定已经完成了延时，也就是说，这张表现在是空的。</p>
<p>此时只有溢出的延时表上的延时需要完成，当溢出再次发生时，<strong>我们又需要一张表</strong>，<strong>难道我们要重新申请一块内存来存储表吗？</strong></p>
<p><strong>显然，完全不需要，因为没有溢出的延时表是空的，我们可以重复利用它。现在，之前溢出的延时表变成了未溢出的延时表，之前未溢出的延时表被重新利用，拿来记录现在溢出的延时任务！</strong></p>
<p>使用两个表进行维护，这就是Sparrow的延时策略。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>先讲解了时间触发型RTOS的设计，然后讲解SysTick时钟，它通常作为RTOS的定时器。为了充分利用定时器，引入延时阻塞的概念，解决了裸机中常见的延时空等待的问题。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RTOS/" rel="tag">RTOS</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/10/29/sparrow%E7%B3%BB%E5%88%97%E5%8D%81%E4%B9%9D/">sparrow系列十九</a><a class="next" href="/2024/10/28/sparrow%E7%B3%BB%E5%88%97%E5%8D%81%E4%B8%83/">sparrow系列十七</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/compiler/" style="font-size: 15px;">compiler</a> <a href="/tags/GDB/" style="font-size: 15px;">GDB</a> <a href="/tags/RTOS/" style="font-size: 15px;">RTOS</a> <a href="/tags/TCP-IP-stack/" style="font-size: 15px;">TCP/IP stack</a> <a href="/tags/UDP/" style="font-size: 15px;">UDP</a> <a href="/tags/C-language/" style="font-size: 15px;">C language</a> <a href="/tags/%E8%99%9A%E5%87%BD%E6%95%B0%E8%A1%A8/" style="font-size: 15px;">虚函数表</a> <a href="/tags/c-flow/" style="font-size: 15px;">c flow</a> <a href="/tags/linux-kernel/" style="font-size: 15px;">linux kernel</a> <a href="/tags/%E5%86%85%E5%AD%98/" style="font-size: 15px;">内存</a> <a href="/tags/Embedded-RTOS/" style="font-size: 15px;">Embedded RTOS</a> <a href="/tags/c-language/" style="font-size: 15px;">c language</a> <a href="/tags/C-lauguage/" style="font-size: 15px;">C lauguage</a> <a href="/tags/compilers/" style="font-size: 15px;">compilers</a> <a href="/tags/data-struct/" style="font-size: 15px;">data struct</a> <a href="/tags/ble/" style="font-size: 15px;">ble</a> <a href="/tags/IP/" style="font-size: 15px;">IP</a> <a href="/tags/cortex-A7/" style="font-size: 15px;">cortex A7</a> <a href="/tags/ebpf/" style="font-size: 15px;">ebpf</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/07/16/ebpf%E6%8A%80%E6%9C%AF/">ebpf技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/03/21/armCA7%E8%99%9A%E6%8B%9F%E5%8C%96/">armCA7虚拟化</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/03/14/cortex-A7%E6%9E%B6%E6%9E%84/">cortex-A7架构</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/03/14/%E5%9C%A8imx6ull-cortex-A7-%E4%B8%8A%E8%BF%90%E8%A1%8CSKRTOS/">在imx6ull(cortex-A7)上运行SKRTOS</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/27/%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%A8%A1%E5%9D%97%E5%8C%96/">代码设计:面向对象和模块化</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/24/buf%E7%BB%93%E6%9E%84/">buf结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/17/IP%E5%8D%8F%E8%AE%AE/">IP协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/08/UDP%E5%8D%8F%E8%AE%AE/">UDP协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/05/%E8%93%9D%E7%89%99%E6%9C%8D%E5%8A%A1/">蓝牙服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/01/19/TCP%E5%8D%8F%E8%AE%AE%E4%B8%80/">TCP协议一</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Hexo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>