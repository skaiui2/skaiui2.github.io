<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>sparrow系列四 | Hexo</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">sparrow系列四</h1><a id="logo" href="/.">Hexo</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">sparrow系列四</h1><div class="post-meta">2024-10-12</div><div class="post-content"><p>skaiuijing</p>
<p>为了验证上一节笔者所说的学习方法，笔者决定让Sparrow先跑起来，并且使用gdb调试Sparrow。不过在此之前，笔者先简单说一下Sparrow RTOS是如何工作的，因为程序只是算法的体现，了解必要的算法，再去看实现，会轻松不少。</p>
<h2 id="RTOS的工作原理"><a href="#RTOS的工作原理" class="headerlink" title="RTOS的工作原理"></a>RTOS的工作原理</h2><p>RTOS，也就是实时操作系统，它与裸机的一个重大区别就是拥有了多线程。多线程，简单理解就是多个任务同时运行。</p>
<h3 id="如何做到同时？"><a href="#如何做到同时？" class="headerlink" title="如何做到同时？"></a>如何做到同时？</h3><p>我们知道mcu在同一时间只能做一件事情，执行一个上下文的代码，在裸机中我们使用while（1）的形式来进行轮询，while（1）中是任务，通常是执行完一个任务代表的函数再去执行下一个，一个任务代表执行的最小单元，那么我们可不可以把任务进行分割呢？</p>
<p>试想，如果mcu不断切换任务，那不就能做到看起来是在同时做两件事情吗？这当然是可以的。</p>
<p><strong>rtos的本质就是不断切换任务达到模拟同时的效果，它把任务分割为更小的单元，从更微观的层面分配任务执行的时间。</strong></p>
<p>我们把切换任务的过程称为上下文切换。</p>
<h3 id="如何切换？"><a href="#如何切换？" class="headerlink" title="如何切换？"></a>如何切换？</h3><p>读者想一想，在arm架构中，有什么东西能够持续执行，完成上下文切换的任务？</p>
<p>答案是：<strong>中断</strong>！</p>
<p>中断是一种异常，在发生中断时，单片机会保存现场，在中断完成后，会及时恢复现场。那么，假设只有两个任务，一个是正常执行的任务，一个是中断中的任务，假设中断不断发生，从微观层面上看，单片机的任务执行过程是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">A[任务A]--中断--&gt;B[任务B]--返回--&gt;c[任务A]--中断--&gt;d[任务B]--返回--&gt;e[任务A]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是从宏观层面上，可不可以理解成这样呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">A[任务A]--中断--&gt;B[任务B]</span><br><span class="line">Aa[任务A]--中断--&gt;Ba[任务B]</span><br><span class="line">Ac[任务A]--中断--&gt;Bb[任务B]</span><br><span class="line">Ad[任务A]--中断--&gt;Bc[任务B]</span><br><span class="line">Ae[任务A]--中断--&gt;Bd[任务B]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读者发现没有，如果我们能利用中断不断分割任务执行的尺度，那么它不就看起来是并行的吗？</p>
<h2 id="观察运行中的Sparrow"><a href="#观察运行中的Sparrow" class="headerlink" title="观察运行中的Sparrow"></a>观察运行中的Sparrow</h2><p>承接上文，笔者将会实践上一篇博客中所说的学习方法。</p>
<p>在第一篇博客中我们已经完成了Sparrow的移植，现在让我们开始上手操作。</p>
<h3 id="让程序先跑起来"><a href="#让程序先跑起来" class="headerlink" title="让程序先跑起来"></a>让程序先跑起来</h3><p>先在Sparrow启动程序这里打上断点（笔者使用的调试软件是gdb，读者也可以使用keil，都是一样的）：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c1.png" alt="img"></p>
<p>现在我们进入了启动程序内部：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c2.png" alt="img"></p>
<p>通过注释，我们可以判断，这是在配置中断，联系上文笔者所说，上下文切换与中断息息相关，所以我们现在要去查找程序中相关的中断。</p>
<p>继续执行程序，我们发现我们进入了一个由汇编程序组成的函数中，这是SVC中断，通过注释，我们知道，就是它开启了第一个任务：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c3.png" alt="img"></p>
<p>继续执行，果然，它进入了第一个任务内部：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c4.png" alt="img"></p>
<p>为了观察上下文切换，程序中的中断是首要观察目标，我们在xPortPendSVHandler和SysTick_Handler里面打上断点，继续执行，在执行完TaskDelay后，程序进入了xPortPendSVHandler中断函数内部：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c5.png" alt="img"></p>
<p>现在让笔者告诉大家，它就是执行上下文切换的中断，在一定时间内它都会触发，完成上下文切换。</p>
<p>继续执行，程序来到了vTaskSwitchContext，看函数名称读者便知道，上下文切换要完成了：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c6.png" alt="img"></p>
<p>对于单片机来说，一个周期内能做无数次事情，我们继续一行行执行，不知道要执行多久，所以我们直接快速运行程序（gdb使用c命令运行到下一个断点处），我们发现我们来到了systick中断这里：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c7.png" alt="img"></p>
<p>对systick有了解的朋友知道，它是一个时钟，也就是说，它会在一定时间周期触发，继续快速运行，我们发现我们又来到了pendsv中断内部：</p>
<p><img src="https://skaiui2.github.io/img/sparrow_c8.png" alt="img"></p>
<p>难道说，systick中断会在一定周期触发PendSV中断，从而不断进行上下文切换吗？</p>
<p><strong>是的，这是正确的！</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过对RTOS原理的一些简单介绍以及上手调试，我们大概知道了RTOS的运行原理：通过中断来进行上下文切换，同时systick中断会不断触发中断，从而使各个任务不断进行切换，从而模拟并行线程。</p>
</div><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RTOS/" rel="tag">RTOS</a></li></ul></div><div class="post-nav"><a class="pre" href="/2024/10/13/sparrow%E7%B3%BB%E5%88%97%E4%BA%94/">sparrow系列五</a><a class="next" href="/2024/10/12/sparrow%E7%B3%BB%E5%88%97%E4%B8%89/">sparrow系列三</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:admin@domain.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/username" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/compiler/" style="font-size: 15px;">compiler</a> <a href="/tags/GDB/" style="font-size: 15px;">GDB</a> <a href="/tags/RTOS/" style="font-size: 15px;">RTOS</a> <a href="/tags/TCP-IP-stack/" style="font-size: 15px;">TCP/IP stack</a> <a href="/tags/UDP/" style="font-size: 15px;">UDP</a> <a href="/tags/C-language/" style="font-size: 15px;">C language</a> <a href="/tags/%E8%99%9A%E5%87%BD%E6%95%B0%E8%A1%A8/" style="font-size: 15px;">虚函数表</a> <a href="/tags/c-flow/" style="font-size: 15px;">c flow</a> <a href="/tags/linux-kernel/" style="font-size: 15px;">linux kernel</a> <a href="/tags/%E5%86%85%E5%AD%98/" style="font-size: 15px;">内存</a> <a href="/tags/Embedded-RTOS/" style="font-size: 15px;">Embedded RTOS</a> <a href="/tags/c-language/" style="font-size: 15px;">c language</a> <a href="/tags/C-lauguage/" style="font-size: 15px;">C lauguage</a> <a href="/tags/compilers/" style="font-size: 15px;">compilers</a> <a href="/tags/data-struct/" style="font-size: 15px;">data struct</a> <a href="/tags/ble/" style="font-size: 15px;">ble</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2025/02/08/UDP%E5%8D%8F%E8%AE%AE/">UDP协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/02/05/%E8%93%9D%E7%89%99%E6%9C%8D%E5%8A%A1/">蓝牙服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/01/19/TCP%E5%8D%8F%E8%AE%AE%E4%B8%80/">TCP协议一</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/01/13/SparrowRTOS%E9%93%BE%E8%A1%A8%E7%89%88%E6%9C%AC/">SparrowRTOS链表版本</a></li><li class="post-list-item"><a class="post-list-link" href="/2025/01/02/%E7%BA%A2%E9%BB%91%E6%A0%91%E5%AE%9E%E7%8E%B0/">红黑树实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/23/%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96%E4%B9%8B%E6%95%B0%E6%8D%AE%E7%AF%87/">程序优化之数据篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/21/%E9%BE%99%E4%B9%A6%E9%99%84%E5%BD%95B%E6%B1%82%E8%A7%A3/">龙书附录B求解</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/17/SparrowRTOS%E7%A7%BB%E6%A4%8D/">SparrowRTOS移植</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/11/C4%E6%BA%90%E7%A0%81%E6%AC%A3%E8%B5%8F/">C4编译器源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/12/10/GdbPythonAPI/">GdbPythonAPI</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2025 <a href="/." rel="nofollow">Hexo.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>